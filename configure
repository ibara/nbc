#!/bin/sh

# This configure script written by Brian Callahan <bcallah@openbsd.org>
# and released into the Public Domain.

cccheck() {
  if [ ! -z "$CC" ] ; then
cat << EOF > conftest.c
int main(void){return 0;}
EOF
    $CC -o conftest conftest.c > /dev/null 2>&1
    if [ $? -eq 0 ] ; then
      ./conftest
      if [ $? -eq 0 ] ; then
	rm -f conftest conftest.c
	cc="$CC"
	return 0
      else
	echo "could not build working executables"
	echo "Please ensure your C compiler is a native compiler"
	exit 1
      fi
    else
      rm -f conftest conftest.c
    fi
  fi

  for compiler in cc clang pcc xlc gcc ; do
cat << EOF > conftest.c
int main(void){return 0;}
EOF

    $compiler -o conftest conftest.c > /dev/null 2>&1

    if [ $? -eq 0 ] ; then
      ./conftest
      if [ $? -eq 0 ] ; then
	rm -f conftest conftest.c
	cc="$compiler"
	return 0
      else
	echo "could not build working executables"
	echo "Please ensure your C compiler is a native compiler"
	exit 1
      fi
    else
      rm -f conftest conftest.c
    fi
  done
  return 1
}

libeditcheck() {
  cat << EOF > conftest.c
#include <histedit.h>
int main(void){el_init(NULL, NULL, NULL, NULL);return 0;}
EOF
  $cc -o conftest conftest.c -ledit $libeditlibs > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.c
    return 0
  else
    rm -f conftest conftest.c
    return 1
  fi
}

readlinecheck() {
  cat << EOF > conftest.c
#include <readline/readline.h>
int main(void){rl_initialize();return 0;}
EOF
  $cc -o conftest conftest.c -lreadline $libreadlinelibs > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.c
    return 0
  else
    rm -f conftest conftest.c
    return 1
  fi
}

setvbufcheck() {
  cat << EOF > conftest.c
#include <stdio.h>
int main(void){setvbuf(NULL,NULL,0,0);return 0;}
EOF
  $cc -o conftest conftest.c > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.c
    return 0
  else
    rm -f conftest conftest.c
    return 1
  fi
}

wflagcheck() {
  cat << EOF > conftest.c
int main(void){return 0;}
EOF
  $cc -w -o conftest conftest.c > /dev/null 2> conftest.err
  grep ':' conftest.err > /dev/null 2>&1
  if [ $? -eq 0 ] ; then
    rm -f conftest conftest.err conftest.c
    return 1
  else
    rm -f conftest conftest.err conftest.c
    return 0
  fi
}

# Option variables
if [ ! -z "$PREFIX" ] ; then
  prefix="$PREFIX"
else
  prefix="/usr/local"
fi

mandir="$prefix/man"

libeditlibs="-ltermcap"
libreadlinelibs="-ltermcap"

instprog="nbc"
static=0

# Options
for opt
do
  case "$opt" in
    --prefix=*)
	prefix=`echo $opt | cut -d '=' -f 2`
	;;
    --mandir=*)
	mandir=`echo $opt | cut -d '=' -f 2`
	;;
    --disable-bc|--enable-bc)
	if [ "x$opt" = "x--enable-bc" ] ; then
	  instprog="bc"
	else
	  instprog="nbc"
	fi
	;;
    --disable-static|--enable-static)
	if [ "x$opt" = "x--enable-static" ] ; then
	  static=1
	else
	  static=0
	fi
	;;
    --help|-h)
	echo "Usage: configure [options]"
	echo ""
	echo "Options:"
	printf "  --help or -h            "
	echo "Display this help message"
	printf "  --prefix=PREFIX         "
	echo "Top level install directory is PREFIX [$prefix]"
	printf "  --mandir=MANDIR         "
	echo "Manual pages are installed to MANDIR [$mandir]"
	printf "  --enable-bc             "
	echo "Install executable as ed [default=$instprog]"
	printf "  --enable-static         "
	echo "Statically link executables [default=no]"
	exit 1
	;;
    *)
	;;
  esac
done

if [ ! -z "$CFLAGS" ] ; then
  cflags="$CFLAGS -I. -funsigned-char"
else
  cflags="-I. -funsigned-char"
fi

if [ ! -z "$LDFLAGS" ] ; then
  ldflags="$LDFLAGS "
else
  ldflags=""
fi

if [ $static -ne 0 ] ; then
  ldflags="${ldflags}-static"
fi

printf "checking for C compiler... "
cccheck
if [ $? -ne 0 ] ; then
  echo "not found"
  echo "Please install a C compiler and re-run configure."
  exit 1
else
  echo "$cc"
fi

printf "checking for -w compiler flag... "
wflagcheck
if [ $? -ne 0 ] ; then
  echo "no"
else
  cflags="$cflags -w"
  echo "yes"
fi

printf "checking for OS... "
os=`uname -s`
echo "$os"
libs=""

case "x$os" in
  "xLinux"|"xCYGWIN"*)
    cflags="$cflags -D_GNU_SOURCE"
    ;;
esac

cat << EOF > config.h
/* This file automatically generated by configure.  */

#define PACKAGE "bc"
#define VERSION "nb1.0"
#define BC_COPYRIGHT "Copyright (C) 1991-1994, 1997, 2000, 2012-2017 "\\
        "Free Software Foundation, Inc.\n"\\
        "Copyright (C) 2004, 2005, 2016-2017 Philip A. Nelson"
#define QUIET

EOF

printf "checking for libedit... "
libeditcheck
if [ $? -eq 0 ] ; then
  libs="-ledit $libeditlibs"
  echo "#define LIBEDIT" >> config.h
  echo "yes"
else
  echo "no"
  printf "checking for readline... "
  readlinecheck
  if [ $? -eq 0 ] ; then
    libs="-lreadline $libreadlinelibs"
    echo "#define READLINE" >> config.h
    echo "yes"
  else
    echo "no"
  fi
fi

printf "checking for setvbuf... "
setvbufcheck
if [ $? -eq 0 ] ; then
  echo "#define HAVE_SETVBUF" >> config.h
  echo "yes"
else
  echo "no"
fi

printf "creating Makefile... "
cat << EOF > Makefile
# This Makefile automatically generated by configure.
.POSIX:

CC =		$cc
CFLAGS =	$cflags
EOF

if [ ! -z "$ldflags" ] ; then
cat << EOF >> Makefile
LDFLAGS =	$ldflags
EOF
fi

cat << EOF >> Makefile
PREFIX ?=	$prefix
MANDIR ?=	$mandir

PROG =	$instprog
OBJS =	bc.o execute.o global.o load.o main.o number.o scan.o \\
	storage.o util.o warranty.o

all: \${PROG}

\${PROG}: \${OBJS}
	\${CC} \${LDFLAGS} -o \${PROG} \${OBJS} $libs

install:
	install -d \${DESTDIR}\${PREFIX}/bin
	install -d \${DESTDIR}\${MANDIR}/man1
	install -c -s -m 755 \${PROG} \${DESTDIR}\${PREFIX}/bin
	install -c -m 644 bc.1 \${DESTDIR}\${MANDIR}/man1/\${PROG}.1

test:
	echo "No tests"

clean:
	rm -f \${PROG} \${OBJS} y.tab.h

distclean: clean
	rm -f Makefile config.h
EOF
echo "done"
